// Copyright 2021-2023 Jacob Alexander
//
// Licensed under the Apache License, Version 2.0, <LICENSE-APACHE or
// http://apache.org/licenses/LICENSE-2.0> or the MIT license <LICENSE-MIT or
// http://opensource.org/licenses/MIT>, at your option. This file may not be
// copied, modified, or distributed except according to those terms.

// TODO This should be configurable using a feature once more lookup sizes are needed
const LOOKUP_SIZE: usize = 1024;

/// Entry for each lookup table
#[repr(C)]
#[derive(Clone, Debug, PartialEq, Eq)]
#[cfg_attr(feature = "defmt", derive(defmt::Format))]
pub struct Entry {
    /// Lookup table
    /// Converts an ADC reading to a linearized distance. Must be used with a calibrated offset to
    /// account for any temperature or humidity drift.
    pub lookup: [i16; LOOKUP_SIZE],
    /// Minimum valid ADC value that can be used with lookup
    /// Not all sensors have a valid full range (i.e. wrong magnet polarity)
    pub min_ok_value: u16,
    /// Maximum valid ADC value that can be used with lookup
    pub max_ok_value: u16,
    /// Typical ADC value when switch is fully released (start of lookup table)
    pub sensor_zero: u16,
    /// Idle minimum
    pub min_idle_value: u16,
    /// Idle maximum
    pub max_idle_value: u16,
}

impl Entry {
    /// Lookup value using raw offset
    ///
    /// Use the min/max ok values to ensure the lookup value is within the valid range
    /// Calibration takes care of min/max ok values
    pub fn lookup(&self, value: u16, offset: i16) -> i16 {
        // TODO We can probably avoid the min/max checks if we need to squeeze out more performance
        let mut lookup_value = value as i16 + offset;
        // If lookup value is negative, use lowest entry
        if lookup_value < self.min_ok_value as i16 {
            lookup_value = self.min_ok_value as i16;
        // If lookup value is greater than max, use max entry
        } else if lookup_value > self.max_ok_value as i16 {
            lookup_value = self.max_ok_value as i16;
        }
        self.lookup[lookup_value as usize]
    }
}

/// Default lookup for Silo Switches (atsam4s/Keystone)
/// Calibrated on a Keystone FS v1.01 (2023-06-19 - 533132004e324b463330393032313030)
///  34.1472*exp(0.63181*x)
pub const SILO_ATSAM4S_LC605_GAIN_4X: Entry = Entry {
    lookup: [
        -1000, -1000, -1000, -1000, -1000, -1000, -1000, -1000, -1000, -1000, -1000, -1000, -1000,
        -1000, -1000, -1000, -1000, -1000, -1000, -1000, -1000, -1000, -1000, -1000, -1000, -1000,
        -1000, -1000, -1000, -1000, -1000, -1000, -1000, -1000, -995, -955, -911, -868, -825, -784,
        -744, -705, -667, -630, -593, -558, -523, -489, -456, -423, -391, -360, -329, -299, -269,
        -240, -212, -184, -156, -129, -102, -76, -50, -25, 0, 24, 48, 72, 96, 119, 142, 164, 186,
        208, 230, 251, 272, 292, 313, 333, 353, 373, 392, 411, 430, 449, 467, 486, 504, 522, 539,
        557, 574, 591, 608, 625, 642, 658, 674, 690, 706, 722, 737, 753, 768, 783, 798, 813, 828,
        843, 857, 871, 886, 900, 914, 927, 941, 955, 968, 981, 995, 1008, 1021, 1034, 1047, 1059,
        1072, 1084, 1097, 1109, 1121, 1134, 1146, 1158, 1169, 1181, 1193, 1204, 1216, 1227, 1239,
        1250, 1261, 1272, 1283, 1294, 1305, 1316, 1327, 1337, 1348, 1358, 1369, 1379, 1390, 1400,
        1410, 1420, 1430, 1440, 1450, 1460, 1470, 1479, 1489, 1499, 1508, 1518, 1527, 1537, 1546,
        1555, 1565, 1574, 1583, 1592, 1601, 1610, 1619, 1628, 1636, 1645, 1654, 1663, 1671, 1680,
        1688, 1697, 1705, 1714, 1722, 1730, 1739, 1747, 1755, 1763, 1771, 1779, 1787, 1795, 1803,
        1811, 1819, 1827, 1835, 1842, 1850, 1858, 1865, 1873, 1880, 1888, 1895, 1903, 1910, 1918,
        1925, 1932, 1940, 1947, 1954, 1961, 1968, 1976, 1983, 1990, 1997, 2004, 2011, 2018, 2024,
        2031, 2038, 2045, 2052, 2058, 2065, 2072, 2079, 2085, 2092, 2098, 2105, 2111, 2118, 2124,
        2131, 2137, 2144, 2150, 2156, 2163, 2169, 2175, 2182, 2188, 2194, 2200, 2206, 2212, 2218,
        2225, 2231, 2237, 2243, 2249, 2255, 2261, 2266, 2272, 2278, 2284, 2290, 2296, 2302, 2307,
        2313, 2319, 2324, 2330, 2336, 2341, 2347, 2353, 2358, 2364, 2369, 2375, 2380, 2386, 2391,
        2397, 2402, 2408, 2413, 2418, 2424, 2429, 2434, 2440, 2445, 2450, 2456, 2461, 2466, 2471,
        2476, 2481, 2487, 2492, 2497, 2502, 2507, 2512, 2517, 2522, 2527, 2532, 2537, 2542, 2547,
        2552, 2557, 2562, 2567, 2572, 2577, 2581, 2586, 2591, 2596, 2601, 2605, 2610, 2615, 2620,
        2624, 2629, 2634, 2638, 2643, 2648, 2652, 2657, 2662, 2666, 2671, 2675, 2680, 2684, 2689,
        2693, 2698, 2702, 2707, 2711, 2716, 2720, 2725, 2729, 2734, 2738, 2742, 2747, 2751, 2755,
        2760, 2764, 2768, 2773, 2777, 2781, 2785, 2790, 2794, 2798, 2802, 2807, 2811, 2815, 2819,
        2823, 2827, 2832, 2836, 2840, 2844, 2848, 2852, 2856, 2860, 2864, 2868, 2872, 2876, 2880,
        2884, 2888, 2892, 2896, 2900, 2904, 2908, 2912, 2916, 2920, 2924, 2928, 2932, 2936, 2939,
        2943, 2947, 2951, 2955, 2959, 2962, 2966, 2970, 2974, 2978, 2981, 2985, 2989, 2993, 2996,
        3000, 3004, 3007, 3011, 3015, 3018, 3022, 3026, 3029, 3033, 3037, 3040, 3044, 3048, 3051,
        3055, 3058, 3062, 3065, 3069, 3073, 3076, 3080, 3083, 3087, 3090, 3094, 3097, 3101, 3104,
        3108, 3111, 3115, 3118, 3122, 3125, 3128, 3132, 3135, 3139, 3142, 3145, 3149, 3152, 3156,
        3159, 3162, 3166, 3169, 3172, 3176, 3179, 3182, 3186, 3189, 3192, 3195, 3199, 3202, 3205,
        3209, 3212, 3215, 3218, 3222, 3225, 3228, 3231, 3234, 3238, 3241, 3244, 3247, 3250, 3253,
        3257, 3260, 3263, 3266, 3269, 3272, 3276, 3279, 3282, 3285, 3288, 3291, 3294, 3297, 3300,
        3303, 3306, 3309, 3313, 3316, 3319, 3322, 3325, 3328, 3331, 3334, 3337, 3340, 3343, 3346,
        3349, 3352, 3355, 3358, 3361, 3364, 3366, 3369, 3372, 3375, 3378, 3381, 3384, 3387, 3390,
        3393, 3396, 3399, 3401, 3404, 3407, 3410, 3413, 3416, 3419, 3422, 3424, 3427, 3430, 3433,
        3436, 3439, 3441, 3444, 3447, 3450, 3453, 3455, 3458, 3461, 3464, 3466, 3469, 3472, 3475,
        3477, 3480, 3483, 3486, 3488, 3491, 3494, 3497, 3499, 3502, 3505, 3507, 3510, 3513, 3515,
        3518, 3521, 3523, 3526, 3529, 3531, 3534, 3537, 3539, 3542, 3545, 3547, 3550, 3553, 3555,
        3558, 3560, 3563, 3566, 3568, 3571, 3573, 3576, 3579, 3581, 3584, 3586, 3589, 3591, 3594,
        3597, 3599, 3602, 3604, 3607, 3609, 3612, 3614, 3617, 3619, 3622, 3624, 3627, 3629, 3632,
        3634, 3637, 3639, 3642, 3644, 3647, 3649, 3652, 3654, 3657, 3659, 3661, 3664, 3666, 3669,
        3671, 3674, 3676, 3678, 3681, 3683, 3686, 3688, 3691, 3693, 3695, 3698, 3700, 3702, 3705,
        3707, 3710, 3712, 3714, 3717, 3719, 3721, 3724, 3726, 3728, 3731, 3733, 3736, 3738, 3740,
        3742, 3745, 3747, 3749, 3752, 3754, 3756, 3759, 3761, 3763, 3766, 3768, 3770, 3772, 3775,
        3777, 3779, 3782, 3784, 3786, 3788, 3791, 3793, 3795, 3797, 3800, 3802, 3804, 3806, 3809,
        3811, 3813, 3815, 3817, 3820, 3822, 3824, 3826, 3828, 3830, 3832, 3834, 3836, 3838, 3841,
        3843, 3845, 3847, 3849, 3851, 3854, 3856, 3858, 3860, 3862, 3864, 3867, 3869, 3871, 3873,
        3875, 3877, 3879, 3882, 3884, 3886, 3888, 3890, 3892, 3894, 3896, 3898, 3901, 3903, 3905,
        3907, 3909, 3911, 3913, 3915, 3917, 3919, 3921, 3924, 3926, 3928, 3930, 3932, 3934, 3936,
        3938, 3940, 3942, 3944, 3946, 3948, 3950, 3952, 3954, 3956, 3958, 3960, 3962, 3964, 3966,
        3968, 3970, 3972, 3974, 3976, 3978, 3980, 3982, 3984, 3986, 3988, 3990, 3992, 3994, 3996,
        3998, 4000, 4002, 4004, 4006, 4008, 4010, 4012, 4014, 4016, 4018, 4020, 4022, 4024, 4026,
        4028, 4030, 4032, 4034, 4035, 4037, 4039, 4041, 4043, 4045, 4047, 4049, 4051, 4053, 4055,
        4057, 4058, 4060, 4062, 4064, 4066, 4068, 4070, 4072, 4074, 4076, 4077, 4079, 4081, 4083,
        4085, 4087, 4089, 4090, 4092, 4094, 4096, 4098, 4100, 4102, 4103, 4105, 4107, 4109, 4111,
        4113, 4115, 4116, 4118, 4120, 4122, 4124, 4126, 4127, 4129, 4131, 4133, 4135, 4136, 4138,
        4140, 4142, 4144, 4145, 4147, 4149, 4151, 4153, 4154, 4156, 4158, 4160, 4162, 4163, 4165,
        4167, 4169, 4170, 4172, 4174, 4176, 4178, 4179, 4181, 4183, 4185, 4186, 4188, 4190, 4192,
        4193, 4195, 4197, 4199, 4200, 4202, 4204, 4206, 4207, 4209, 4211, 4212, 4214, 4216, 4218,
        4219, 4221, 4223, 4224, 4226, 4228, 4230, 4231, 4233, 4235, 4236, 4238, 4240, 4242, 4243,
        4245, 4247, 4248, 4250, 4252, 4253, 4255, 4257, 4258, 4260, 4262, 4263, 4265, 4267, 4268,
        4270, 4272, 4273, 4275, 4277, 4278, 4280, 4282, 4283, 4285, 4287, 4288, 4290, 4292, 4293,
        4295, 4296, 4298, 4300, 4301, 4303, 4305, 4306, 4308, 4310, 4311, 4313, 4314, 4316, 4318,
        4319, 4321, 4322, 4324, 4326, 4327, 4329, 4330, 4332, 4334, 4335, 4337, 4338, 4340, 4342,
        4343, 4345, 4346, 4348, 4350, 4351, 4353, 4354, 4356, 4357, 4359, 4361, 4362, 4364, 4365,
        4367, 4368, 4370, 4372, 4373, 4375, 4376, 4378, 4379, 4381, 4382, 4384, 4386,
    ],
    min_ok_value: 0,
    max_ok_value: 1023,
    sensor_zero: 64,
    min_idle_value: 0,
    //min_idle_value: 40, // TODO is it ok to leave at 0? 40 is technically a better tuned value
    max_idle_value: 170,
};

/// Calibrated on a Keystone FS v(TODO)
pub const SILO_ATSAM4S_LC605_GAIN_2X: Entry = Entry {
    lookup: [
        -512, -511, -510, -509, -508, -507, -506, -505, -504, -503, -502, -501, -500, -499, -498,
        -497, -496, -495, -494, -493, -492, -491, -490, -489, -488, -487, -486, -485, -484, -483,
        -482, -481, -480, -479, -478, -477, -476, -475, -474, -473, -472, -471, -470, -469, -468,
        -467, -466, -465, -464, -463, -462, -461, -460, -459, -458, -457, -456, -455, -454, -453,
        -452, -451, -450, -449, -448, -447, -446, -445, -444, -443, -442, -441, -440, -439, -438,
        -437, -436, -435, -434, -433, -432, -431, -430, -429, -428, -427, -426, -425, -424, -423,
        -422, -421, -420, -419, -418, -417, -416, -415, -414, -413, -412, -411, -410, -409, -408,
        -407, -406, -405, -404, -403, -402, -401, -400, -399, -398, -397, -396, -395, -394, -393,
        -392, -391, -390, -389, -388, -387, -386, -385, -384, -383, -382, -381, -380, -379, -378,
        -377, -376, -375, -374, -373, -372, -371, -370, -369, -368, -367, -366, -365, -364, -363,
        -362, -361, -360, -359, -358, -357, -356, -355, -354, -353, -352, -351, -350, -349, -348,
        -347, -346, -345, -344, -343, -342, -341, -340, -339, -338, -337, -336, -335, -334, -333,
        -332, -331, -330, -329, -328, -327, -326, -325, -324, -323, -322, -321, -320, -319, -318,
        -317, -316, -315, -314, -313, -312, -311, -310, -309, -308, -307, -306, -305, -304, -303,
        -302, -301, -300, -299, -298, -297, -296, -295, -294, -293, -292, -291, -290, -289, -288,
        -287, -286, -285, -284, -283, -282, -281, -280, -279, -278, -277, -276, -275, -274, -273,
        -272, -271, -270, -269, -268, -267, -266, -265, -264, -263, -262, -261, -260, -259, -258,
        -257, -256, -255, -254, -253, -252, -251, -250, -249, -248, -247, -246, -245, -244, -243,
        -242, -241, -240, -239, -238, -237, -236, -235, -234, -233, -232, -231, -230, -229, -228,
        -227, -226, -225, -224, -223, -222, -221, -220, -219, -218, -217, -216, -215, -214, -213,
        -212, -211, -210, -209, -208, -207, -206, -205, -204, -203, -202, -201, -200, -199, -198,
        -197, -196, -195, -194, -193, -192, -191, -190, -189, -188, -187, -186, -185, -184, -183,
        -182, -181, -180, -179, -178, -177, -176, -175, -174, -173, -172, -171, -170, -169, -168,
        -167, -166, -165, -164, -163, -162, -161, -160, -159, -158, -157, -156, -155, -154, -153,
        -152, -151, -150, -149, -148, -147, -146, -145, -144, -143, -142, -141, -140, -139, -138,
        -137, -136, -135, -134, -133, -132, -131, -130, -129, -128, -127, -126, -125, -124, -123,
        -122, -121, -120, -119, -118, -117, -116, -115, -114, -113, -112, -111, -110, -109, -108,
        -107, -106, -105, -104, -103, -102, -101, -100, -99, -98, -97, -96, -95, -94, -93, -92,
        -91, -90, -89, -88, -87, -86, -85, -84, -83, -82, -81, -80, -79, -78, -77, -76, -75, -74,
        -73, -72, -71, -70, -69, -68, -67, -66, -65, -64, -63, -62, -61, -60, -59, -58, -57, -56,
        -55, -54, -53, -52, -51, -50, -49, -48, -47, -46, -45, -44, -43, -42, -41, -40, -39, -38,
        -37, -36, -35, -34, -33, -32, -31, -30, -29, -28, -27, -26, -25, -24, -23, -22, -21, -20,
        -19, -18, -17, -16, -15, -14, -13, -12, -11, -10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 0, 1,
        2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26,
        27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49,
        50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72,
        73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95,
        96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114,
        115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132,
        133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150,
        151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168,
        169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186,
        187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204,
        205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222,
        223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240,
        241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 257, 258,
        259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276,
        277, 278, 279, 280, 281, 282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294,
        295, 296, 297, 298, 299, 300, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 312,
        313, 314, 315, 316, 317, 318, 319, 320, 321, 322, 323, 324, 325, 326, 327, 328, 329, 330,
        331, 332, 333, 334, 335, 336, 337, 338, 339, 340, 341, 342, 343, 344, 345, 346, 347, 348,
        349, 350, 351, 352, 353, 354, 355, 356, 357, 358, 359, 360, 361, 362, 363, 364, 365, 366,
        367, 368, 369, 370, 371, 372, 373, 374, 375, 376, 377, 378, 379, 380, 381, 382, 383, 384,
        385, 386, 387, 388, 389, 390, 391, 392, 393, 394, 395, 396, 397, 398, 399, 400, 401, 402,
        403, 404, 405, 406, 407, 408, 409, 410, 411, 412, 413, 414, 415, 416, 417, 418, 419, 420,
        421, 422, 423, 424, 425, 426, 427, 428, 429, 430, 431, 432, 433, 434, 435, 436, 437, 438,
        439, 440, 441, 442, 443, 444, 445, 446, 447, 448, 449, 450, 451, 452, 453, 454, 455, 456,
        457, 458, 459, 460, 461, 462, 463, 464, 465, 466, 467, 468, 469, 470, 471, 472, 473, 474,
        475, 476, 477, 478, 479, 480, 481, 482, 483, 484, 485, 486, 487, 488, 489, 490, 491, 492,
        493, 494, 495, 496, 497, 498, 499, 500, 501, 502, 503, 504, 505, 506, 507, 508, 509, 510,
        511,
    ],
    min_ok_value: 0,
    max_ok_value: 1023,
    sensor_zero: 220,
    min_idle_value: 260,
    max_idle_value: 290,
};
